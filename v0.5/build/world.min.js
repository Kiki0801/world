/*world_0.4.0 2015-06-14*/

function getEnv(item){var i,j,items=w.Map.items,res=[];for(i=item.x-1;i<=item.x+1;i++)for(j=item.y-1;j<=item.y+1;j++)(i!==item.x||j!==item.y)&&items[i]&&items[i][j]instanceof w.Item.Item&&res.push(items[i][j]);return res}var w={ns:function(ns){var i,len,parts=ns.split("."),object=this;for(i=0,len=parts.length;len>i;i++)object[parts[i]]||(object[parts[i]]={}),object=object[parts[i]];return object}};w.ns("Debug"),w.Debug.on=!1,w.Debug.console=function(obj){w.Debug.on&&console.log(obj)},w.Debug.alert=function(str){w.Debug.on&&alert(str)},w.c=w.Debug.console,w.a=w.Debug.alert,w.ns("Const"),w.Const.MAP=["############################","#c**   #  * #     ***  **c##","#  **** *   **c    *** c   #","#     c    #####       *   #","## ****    # c #    ##   c #","### *      *  ##  ***#     #","#   *c   *  ###  **  #*  * #","#   ####          *    *   #","# * ## *     *    **    *  #","#*** # c ***   **  *  *### #","#*   #*  *  c * *  *     **#","############################"],w.Const.TYPE={"#":"Wall"," ":"Space","*":"Grass",c:"Fish"},w.Const.SPEC={WALL:{name:"Wall",tag:"#",life:NaN,step:0,baseEnergy:0,currEnergy:0,fullEnergy:NaN,x:0,y:0},SPACE:{name:"Space",tag:" ",life:0,step:0,baseEnergy:0,currEnergy:0,fullEnergy:NaN,x:0,y:0},GRASS:{name:"Grass",tag:"*",life:3,step:0,baseEnergy:2,currEnergy:2,fullEnergy:4,x:0,y:0},FISH:{name:"Fish",tag:"c",life:7,step:1,baseEnergy:5,currEnergy:5,fullEnergy:8,x:0,y:0}},w.ns("Item"),w.Item.bury=function(x,y){w.Map.items[x][y]=w.Item.create("Space",x,y)},w.Item.beget=function(parent,x,y){var items=w.Map.items,create=w.Item.create,child=create(parent.name,x,y);items[x][y]=child,parent.currEnergy-=parent.baseEnergy},w.Item.Item=function(spec){this.name=spec.name,this.tag=spec.tag,this.life=spec.life,this.step=spec.step,this.baseEnergy=spec.baseEnergy,this.currEnergy=spec.currEnergy,this.fullEnergy=spec.fullEnergy,this.x=spec.x,this.y=spec.y},w.Item.Item.prototype.grow=function(){},w.Item.Item.prototype.moveTo=function(x,y){var newItem,attr,energy,items=w.Map.items,create=w.Item.create,bury=w.Item.bury,thisX=this.x,thisY=this.y;newItem=create(this.name,x,y);for(attr in newItem)Object.hasOwnProperty&&newItem.hasOwnProperty(attr)&&"x"!==attr&&"y"!==attr&&(newItem[attr]=this[attr]);energy=items[x][y].currEnergy,energy>0&&(newItem.currEnergy+=energy),items[x][y]=newItem,bury(thisX,thisY)},w.Item.Item.prototype.toString=function(){return this.name+"("+this.x+", "+this.y+")"},w.Item.Wall=function(x,y){var spec=w.Const.SPEC.WALL;spec.x=x,spec.y=y,w.Item.Item.call(this,spec)},w.Item.Wall.prototype=new w.Item.Item({}),w.Item.Space=function(x,y){var spec=w.Const.SPEC.SPACE;spec.x=x,spec.y=y,w.Item.Item.call(this,spec)},w.Item.Space.prototype=new w.Item.Item({}),w.Item.Grass=function(x,y){var spec=w.Const.SPEC.GRASS;spec.x=x,spec.y=y,w.Item.Item.call(this,spec)},w.Item.Grass.prototype=new w.Item.Item({}),w.Item.Grass.prototype.grow=function(){this.life--,0===this.life?(w.Item.bury(this.x,this.y),console.log(this+" passed away")):this.currEnergy++},w.Item.Fish=function(x,y){var spec=w.Const.SPEC.FISH;spec.x=x,spec.y=y,w.Item.Item.call(this,spec)},w.Item.Fish.prototype=new w.Item.Item({}),w.Item.Fish.prototype.grow=function(){this.life--,0===this.life?(w.Item.bury(this.x,this.y),console.log(this+" passed away")):(this.currEnergy--,0===this.currEnergy&&(w.Item.bury(this.x,this.y),console.log(this+" starved to death")))},w.Item.create=function(type,x,y){return new w.Item[type](x,y)},w.ns("Map"),w.Map.items=[],w.Map.init=function(){var row,item,i,j,arr=w.Const.MAP,TYPE=w.Const.TYPE,items=w.Map.items,Item=w.Item;for(i=0;i<arr.length;i++){for(row=[],j=0;j<arr[i].length;j++)item=Item.create(TYPE[arr[i].charAt(j)],i,j),row.push(item);items.push(row)}},w.Map.toString=function(){var row,i,j,items=w.Map.items,msg=[];for(i=0;i<items.length;i++){for(row=[],j=0;j<items[i].length;j++)row.push(items[i][j].tag);msg.push(row.join(""))}return msg.join("\n")},w.Map.draw=function(){console.log(w.Map.toString());for(var counter={},items=w.Map.items,i=0;i<items.length;i++)for(var j=0;j<items[i].length;j++)counter[items[i][j].name]||(counter[items[i][j].name]=0),counter[items[i][j].name]++;console.log("fish: "+(counter.Fish||0)+" grass: "+(counter.Grass||0))},w.ns("Util"),w.Util.rand=function(min,max){var num,maxEx=max+2;do num=Math.round(Math.random()*(maxEx-min)+min),num--;while(min>num||num>max);return num},w.ns("Core"),w.Core.init=function(){w.Map.init(),w.Map.draw()},w.Core.run=function(){function move(item){var env,target,ix,iy,tx,ty,i,rand=w.Util.rand,items=w.Map.items,beget=w.Item.beget,pos={x:-1,y:-1},index=-1;if(0!==item.step){for(env=getEnv(item),i=0;i<env.length;i++)("Wall"===env[i].name||env[i].name===item.name)&&env.splice(i--,1);if(0===env.length)return;for(i=0;i<env.length;i++)if("Grass"===env[i].name){index=i;break}for(-1===index&&(index=rand(0,env.length-1)),target=env[index],ix=item.x,iy=item.y,tx=target.x,ty=target.y,items[ix][iy].moveTo(tx,ty),env=getEnv(items[tx][ty]),i=0;i<env.length;i++)"Space"!==env[i].name&&env.splice(i--,1);env.length>0&&(index=rand(0,env.length-1),items[tx][ty].currEnergy>=items[tx][ty].fullEnergy&&env.length>0&&beget(items[tx][ty],env[index].x,env[index].y)),pos.x=tx,pos.y=ty}return pos}var env,index,pos,i,j,k,items=w.Map.items,rand=w.Util.rand,beget=w.Item.beget,moved=[];for(i=0;i<items.length;i++)for(j=0;j<items[i].length;j++)if(!moved[i]||moved[i][j]!==!0){if(items[i][j].grow(),items[i][j].life>0&&items[i][j].currEnergy>=items[i][j].fullEnergy){for(env=getEnv(items[i][j]),k=0;k<env.length;k++)"Space"!==env[k].name&&env.splice(k--,1);env.length>0&&(index=rand(0,env.length-1),beget(items[i][j],env[index].x,env[index].y))}pos=move(items[i][j]),-1!==pos.x&&-1!==pos.y&&("[object Array]"!==Object.prototype.toString.call(moved[pos.x])&&(moved[pos.x]=[]),moved[pos.x][pos.y]=!0)}w.Map.draw()};

/* author: http://ayqy.net/ */