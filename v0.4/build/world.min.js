/*world_0.4.0 2015-05-21*/

function getEnv(item){var i,j,items=w.Map.items,res=[];for(i=item.x-1;i<=item.x+1;i++)for(j=item.y-1;j<=item.y+1;j++)(i!==item.x||j!==item.y)&&items[i]&&items[i][j]instanceof w.Item.Item&&res.push(items[i][j]);return res}var w={ns:function(ns){var i,len,parts=ns.split("."),object=this;for(i=0,len=parts.length;len>i;i++)object[parts[i]]||(object[parts[i]]={}),object=object[parts[i]];return object}};w.ns("Const"),w.Const.MAP=["############################","#c**   #    #     ***     ##","#cc****            **      #","#          #####           #","## ****    #   #    ##     #","###           ##  ***#     #","#           ###  **  #     #","#   ####                   #","# * ##       *             #","# ** #         **      ### #","#    #          *          #","############################"],w.Const.TYPE={"#":"Wall"," ":"Space","*":"Grass",c:"Fish"},w.Const.SPEC={WALL:{name:"Wall",tag:"#",life:NaN,step:0,baseEnergy:0,currEnergy:0,fullEnergy:NaN,x:0,y:0},SPACE:{name:"Space",tag:" ",life:0,step:0,baseEnergy:0,currEnergy:0,fullEnergy:NaN,x:0,y:0},GRASS:{name:"Grass",tag:"*",life:3,step:0,baseEnergy:2,currEnergy:2,fullEnergy:4,x:0,y:0},FISH:{name:"Fish",tag:"c",life:7,step:1,baseEnergy:5,currEnergy:5,fullEnergy:10,x:0,y:0}},w.ns("Item"),w.Item.bury=function(x,y){w.Map.items[x][y]=w.Item.create("Space",x,y)},w.Item.Item=function(spec){this.name=spec.name,this.tag=spec.tag,this.life=spec.life,this.step=spec.step,this.baseEnergy=spec.baseEnergy,this.currEnergy=spec.currEnergy,this.fullEnergy=spec.fullEnergy,this.x=spec.x,this.y=spec.y},w.Item.Item.prototype.grow=function(){},w.Item.Item.prototype.moveTo=function(x,y){var newItem,attr,items=w.Map.items,create=w.Item.create,bury=w.Item.bury,thisX=this.x,thisY=this.y;newItem=create(this.name,x,y);for(attr in newItem)Object.hasOwnProperty&&newItem.hasOwnProperty(attr)&&"x"!==attr&&"y"!==attr&&(newItem[attr]=this[attr]);items[x][y]=newItem,bury(thisX,thisY)},w.Item.Item.prototype.toString=function(){return this.name+"("+this.x+", "+this.y+")"},w.Item.Wall=function(x,y){var spec=w.Const.SPEC.WALL;spec.x=x,spec.y=y,w.Item.Item.call(this,spec)},w.Item.Wall.prototype=new w.Item.Item({}),w.Item.Space=function(x,y){var spec=w.Const.SPEC.SPACE;spec.x=x,spec.y=y,w.Item.Item.call(this,spec)},w.Item.Space.prototype=new w.Item.Item({}),w.Item.Grass=function(x,y){var spec=w.Const.SPEC.GRASS;spec.x=x,spec.y=y,w.Item.Item.call(this,spec)},w.Item.Grass.prototype=new w.Item.Item({}),w.Item.Grass.prototype.grow=function(){this.life--,0===this.life?(w.Item.bury(this.x,this.y),console.log(this+" passed away")):this.currEnergy++},w.Item.Fish=function(x,y){var spec=w.Const.SPEC.FISH;spec.x=x,spec.y=y,w.Item.Item.call(this,spec)},w.Item.Fish.prototype=new w.Item.Item({}),w.Item.Fish.prototype.grow=function(){this.life--,0===this.life?(w.Item.bury(this.x,this.y),console.log(this+" passed away")):(this.currEnergy--,0===this.currEnergy&&(w.Item.bury(this.x,this.y),console.log(this+" starved to death")))},w.Item.create=function(type,x,y){return new w.Item[type](x,y)},w.ns("Map"),w.Map.items=[],w.Map.init=function(){var row,item,i,j,arr=w.Const.MAP,TYPE=w.Const.TYPE,items=w.Map.items,Item=w.Item;for(i=0;i<arr.length;i++){for(row=[],j=0;j<arr[i].length;j++)item=Item.create(TYPE[arr[i].charAt(j)],i,j),row.push(item);items.push(row)}},w.Map.toString=function(){var row,i,j,items=w.Map.items,msg=[];for(i=0;i<items.length;i++){for(row=[],j=0;j<items[i].length;j++)row.push(items[i][j].tag);msg.push(row.join(""))}return msg.join("\n")},w.Map.draw=function(){console.log(w.Map.toString())},w.ns("Util"),w.Util.rand=function(min,max){var num,maxEx=max+2;do num=Math.round(Math.random()*(maxEx-min)+min),num--;while(min>num||num>max);return num},w.ns("Core"),w.Core.init=function(){w.Map.init(),w.Map.draw()},w.Core.run=function(){function move(item){var index,env,target,ix,iy,tx,ty,i,rand=w.Util.rand,items=w.Map.items,pos={x:0,y:0};if(0!==item.step){for(env=getEnv(item),i=0;i<env.length;i++)"Wall"===env[i].name&&env.splice(i--,1);index=rand(0,env.length-1),target=env[index],ix=item.x,iy=item.y,tx=target.x,ty=target.y,console.log(item),console.log(item+" -> "+target),console.log(target),items[ix][iy].moveTo(tx,ty),pos.x=tx,pos.y=ty}return pos}var pos,i,j,items=w.Map.items,moved=[];for(i=0;i<items.length;i++)for(j=0;j<items[i].length;j++)moved[i]&&moved[i][j]===!0||(items[i][j].grow(),pos=move(items[i][j]),moved[pos.x]=[],moved[pos.x][pos.y]=!0);w.Map.draw()};

/* author: http://ayqy.net/ */